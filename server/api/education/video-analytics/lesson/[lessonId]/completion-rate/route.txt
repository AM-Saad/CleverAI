import { NextRequest, NextResponse } from 'next/server';
import prisma from '@/lib/prisma';

export async function GET(req: NextRequest, { params }: { params: { lessonId: string } }) {
  const lessonId = params.lessonId;
  if (!lessonId) {
    return NextResponse.json({ error: 'Missing lessonId' }, { status: 400 });
  }

  // Get all students who started the video (any event)
  const started = await prisma.videoWatchEvent.findMany({
    where: { lessonId },
    select: { studentId: true },
    distinct: ['studentId'],
  });
  const totalStarted = started.length;

  // Get all students who completed the video
  const completed = await prisma.videoWatchEvent.findMany({
    where: { lessonId, event: 'complete' },
    select: { studentId: true },
    distinct: ['studentId'],
  });
  const totalCompleted = completed.length;

  const completionRate = totalStarted === 0 ? 0 : totalCompleted / totalStarted;

  return NextResponse.json({ completionRate });
}
