# Nuxt Auth Deep Audit Report

Date: 2025-12-21
App: Nuxt 4 + @sidebase/nuxt-auth + Prisma (MongoDB) + Nitro

## Summary
- Status: Completed audit and applied safe fixes.
- Key Fix: Removed session access from global Nitro middleware and expanded auth route exclusions.
- Action Needed: Ensure protected API routes call `requireAuth` in the handler.

## Findings
- **Auth handler file**: server/api/auth/[...].ts
  - Present and correctly exporting: `export default NuxtAuthHandler({...})`.
  - Providers: Google + Credentials. Uses `runtimeConfig.nuxtAuthSecret`.

- **Session usage**:
  - Found session calls in global middleware `_auth.ts` (unsafe).
  - Fixed by moving `requireAuth` and `requireRole` to `server/utils/auth.ts` and removing session calls from middleware.
  - `safeGetServerSession` is used inside individual API handlers (good pattern), e.g. `server/api/user/profile.get.ts`.

- **Middleware exclusions**: ~~/server/utils/auth.ts
  - Originally missing base `/api/auth` and `/api/auth/session` in exclusions.
  - Patched to include: `/api/auth`, `/api/auth/`, `/api/auth/session` and other public utilities.

- **Client route middleware**: app/middleware/auth.global.ts
  - Uses `useAuth()` to gate client routes. Skips `/api/**` (correct).

- **Nuxt config**: nuxt.config.ts
  - `auth` block present with `baseURL: "/api/auth"`, `provider.type: "authjs"`, `trustHost: true`, `originEnvKey: "AUTH_ORIGIN"`.
  - `routeRules` do not include `/api/auth/**` (good).

- **Prisma**
  - Schema present at `prisma/schema.prisma` (MongoDB). `@prisma/client` and `prisma` pinned at 4.8.1.
  - Global Prisma client middleware `server/middleware/0.prisma.ts` attaches `event.context.prisma` (good).

- **Dockerfile**
  - `COPY prisma ./prisma` occurs before `yarn install` and `prisma generate` runs in build stage (correct order).

- **Dependencies**: package.json
  - `next-auth`: present at `~4.21.1` (required peer for @sidebase/nuxt-auth).
  - `@sidebase/nuxt-auth`: ^0.9.4.

- **Nitro plugin**: server/plugins/session-error-handler.ts
  - Adds graceful handling for session errors and avoids recursion on `/api/auth/session`.

## Changes Applied
1. **Created** `server/utils/auth.ts`
   - Exports `requireAuth(event)` and `requireRole(event, roles)`.
   - Uses `safeGetServerSession` and Prisma from `event.context`.
2. **Refactored** `~~/server/utils/auth.ts`
   - Removed session calls and helper exports from middleware.
   - Expanded `publicEndpoints` to include `/api/auth`, `/api/auth/`, `/api/auth/session`.
   - Middleware now only logs and lets route handlers manage auth.

## Recommended Next Steps
- **Route-level protection**
  - For any API that requires authentication, call `requireAuth` at the top of the handler.
  - Example:
    ```ts
    import { requireAuth } from "../utils/auth";

    export default defineEventHandler(async (event) => {
      await requireAuth(event);
      // ... rest of handler
    });
    ```
- **Environment**
  - Ensure `NUXT_AUTH_SECRET` and `AUTH_ORIGIN` are set in prod/staging.
  - Confirm `AUTH_ORIGIN` matches the deployed base URL (protocol + host + port if needed).

- **Monitoring**
  - Keep `server/plugins/session-error-handler.ts` to gracefully handle `/api/auth/session` during transient failures.

## Risk Assessment
- Removing middleware-based auth enforcement may expose routes that assumed global protection. Review critical API routes and add `requireAuth`.

## No Issues Detected In
- `routeRules` including `/api/auth/**` (none found).
- Docker Prisma copy order (correct).
- Presence of `next-auth` peer dependency (present).

---
Generated by Nuxt Auth Deep Audit.
